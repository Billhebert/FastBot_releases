<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>PIX</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="menu-container"></div>

    <div class="container">
      <h1>Gerenciar Chaves PIX</h1>

      <div class="add-form">
        <h3>Adicionar Chaves PIX</h3>
        <textarea
          id="pix-keys"
          placeholder="Cole as chaves PIX aqui (uma por linha)&#10;&#10;Exemplos:&#10;123.456.789-00 (CPF)&#10;12.345.678/0001-00 (CNPJ)&#10;email@example.com (Email)&#10;+5511999999999 (Telefone)&#10;abc123def456 (Aleatoria)"
          rows="8"
        ></textarea>
        <button onclick="addPixKeys()">Adicionar Chaves</button>
      </div>

      <div class="pix-list">
        <h3>Chaves Cadastradas</h3>
        <div id="pix-container">Carregando...</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="notifications.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>

    <script>
      let currentUser = null;

      async function init() {
        currentUser = await requirePagePermission("pix");
        if (!currentUser) return;
        document.getElementById("menu-container").innerHTML = createMenu(currentUser);
        await loadPixKeys();
      }

      function detectPixKeyType(key) {
        const clean = key.replace(/\D/g, "");

        // CPF: 11 digitos
        if (clean.length === 11) return "cpf";

        // CNPJ: 14 digitos
        if (clean.length === 14) return "cnpj";

        // Email
        if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(key)) return "email";

        // Telefone: +55 seguido de 10-11 digitos
        if (/^\+?\d{10,15}$/.test(key)) return "phone";

        // Chave aleatoria (EVP)
        return "random";
      }

      async function loadPixKeys() {
        try {
          const { data, error } = await supabaseClient
            .from("pix_keys")
            .select("*")
            .eq("user_id", currentUser.id)
            .order("created_at", { ascending: false });

          if (error) throw error;

          const container = document.getElementById("pix-container");

          if (!data || data.length === 0) {
            container.innerHTML = "<p>Nenhuma chave PIX cadastrada</p>";
            return;
          }

          container.innerHTML = data
            .map(
              (pix) => `
          <div class="pix-item">
            <div>
              <strong>${pix.key}</strong>
              <span class="badge">${pix.key_type.toUpperCase()}</span>
            </div>
            <button onclick="deletePixKey('${pix.id}')">Excluir</button>
          </div>
        `
            )
            .join("");
        } catch (error) {
          showNotification(
            "Erro ao carregar chaves PIX: " + error.message,
            "error"
          );
        }
      }

      async function addPixKeys() {
        const keysText = document.getElementById("pix-keys").value;

        if (!keysText.trim()) {
          showNotification("Digite pelo menos uma chave PIX", "warning");
          return;
        }

        const keys = keysText
          .split("\n")
          .map((k) => k.trim())
          .filter((k) => k);

        if (keys.length === 0) {
          showNotification("Nenhuma chave valida encontrada", "warning");
          return;
        }

        try {
          const pixData = keys.map((key) => ({
            key,
            key_type: detectPixKeyType(key),
            user_id: currentUser.id,
          }));

          const { error } = await supabaseClient
            .from("pix_keys")
            .insert(pixData);

          if (error) throw error;

          document.getElementById("pix-keys").value = "";
          showNotification(
            `${keys.length} chave(s) PIX adicionada(s)!`,
            "success"
          );
          await loadPixKeys();
        } catch (error) {
          showNotification(
            "Erro ao adicionar chaves: " + error.message,
            "error"
          );
        }
      }

      async function deletePixKey(id) {
        const confirmed = await confirm("Confirma exclusao desta chave PIX?");
        if (!confirmed) return;

        try {
          const { error } = await supabaseClient
            .from("pix_keys")
            .delete()
            .eq("id", id)
            .eq("user_id", currentUser.id);

          if (error) throw error;

          showNotification("Chave PIX excluida", "success");
          await loadPixKeys();
        } catch (error) {
          showNotification("Erro ao excluir: " + error.message, "error");
        }
      }

      init();
    </script>
  </body>
</html>
