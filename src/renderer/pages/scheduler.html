<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento - FastBot</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .scheduler-container {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .page-header {
      margin-bottom: 30px;
    }

    .page-header h1 {
      color: #d4af37;
      margin-bottom: 10px;
    }

    .page-header p {
      color: #888;
      margin: 0;
    }

    .actions-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .btn-new-schedule {
      padding: 12px 25px;
      background: linear-gradient(135deg, #d4af37 0%, #c49a2a 100%);
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-new-schedule:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
    }

    .schedules-grid {
      display: grid;
      gap: 20px;
    }

    .schedule-card {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid #444;
      border-radius: 12px;
      padding: 25px;
      position: relative;
      transition: all 0.3s;
    }

    .schedule-card:hover {
      border-color: #d4af37;
      box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
    }

    .schedule-card.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2ecc71, #27ae60);
      border-radius: 12px 12px 0 0;
    }

    .schedule-card.paused::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #f1c40f, #f39c12);
      border-radius: 12px 12px 0 0;
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .schedule-title {
      flex: 1;
    }

    .schedule-title h3 {
      color: #fff;
      font-size: 18px;
      margin: 0 0 5px 0;
    }

    .schedule-title p {
      color: #888;
      font-size: 13px;
      margin: 0;
    }

    .schedule-status {
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }

    .status-paused {
      background: rgba(241, 196, 15, 0.2);
      color: #f1c40f;
    }

    .status-inactive {
      background: rgba(149, 165, 166, 0.2);
      color: #95a5a6;
    }

    .schedule-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .detail-icon {
      width: 35px;
      height: 35px;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .detail-info {
      flex: 1;
    }

    .detail-info label {
      color: #888;
      font-size: 11px;
      text-transform: uppercase;
      display: block;
      margin-bottom: 3px;
    }

    .detail-info span {
      color: #fff;
      font-weight: 600;
    }

    .schedule-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-play {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
      border: 1px solid #2ecc71;
    }

    .btn-pause {
      background: rgba(241, 196, 15, 0.2);
      color: #f1c40f;
      border: 1px solid #f1c40f;
    }

    .btn-edit {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border: 1px solid #3498db;
    }

    .btn-delete {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 12px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      color: #d4af37;
      margin-bottom: 25px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      color: #d4af37;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      background: #0d0d0d;
      border: 1px solid #444;
      border-radius: 6px;
      color: #fff;
      padding: 12px 15px;
      font-size: 14px;
      outline: none;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #d4af37;
    }

    .form-group small {
      color: #888;
      font-size: 12px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    .btn-cancel {
      background: #333;
      color: #fff;
      padding: 12px 25px;
    }

    .btn-save {
      background: linear-gradient(135deg, #d4af37 0%, #c49a2a 100%);
      color: #1a1a1a;
      padding: 12px 25px;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #666;
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="titlebar" id="titlebar"></header>

      <div class="scheduler-container">
        <!-- Page Header -->
        <div class="page-header">
          <h1>‚è∞ Agendamento de Execu√ß√µes</h1>
          <p>Automatize suas execu√ß√µes de macros em hor√°rios espec√≠ficos</p>
        </div>

        <!-- Actions Bar -->
        <div class="actions-bar">
          <button class="btn-new-schedule" onclick="openScheduleModal()">
            ‚ûï Novo Agendamento
          </button>
        </div>

        <!-- Schedules Grid -->
        <div class="schedules-grid" id="schedules-grid">
          <div class="empty-state">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <h3>Nenhum agendamento configurado</h3>
            <p>Clique em "Novo Agendamento" para come√ßar</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Schedule Modal -->
  <div class="modal" id="schedule-modal">
    <div class="modal-content">
      <h2 id="modal-title">‚è∞ Novo Agendamento</h2>

      <form id="schedule-form" onsubmit="saveSchedule(event)">
        <div class="form-grid">
          <div class="form-group">
            <label for="schedule-name">Nome *</label>
            <input type="text" id="schedule-name" required placeholder="Ex: Execu√ß√£o Di√°ria">
          </div>

          <div class="form-group">
            <label for="schedule-macro">Macro *</label>
            <select id="schedule-macro" required>
              <option value="">Selecione um macro</option>
            </select>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="schedule-frequency">Frequ√™ncia *</label>
            <select id="schedule-frequency" required onchange="updateFrequencyOptions()">
              <option value="once">Uma vez</option>
              <option value="daily">Diariamente</option>
              <option value="weekly">Semanalmente</option>
              <option value="monthly">Mensalmente</option>
            </select>
          </div>

          <div class="form-group">
            <label for="schedule-time">Hor√°rio *</label>
            <input type="time" id="schedule-time" required>
          </div>
        </div>

        <div class="form-grid" id="weekly-options" style="display: none;">
          <div class="form-group">
            <label for="schedule-weekday">Dia da Semana</label>
            <select id="schedule-weekday">
              <option value="0">Domingo</option>
              <option value="1">Segunda-feira</option>
              <option value="2">Ter√ßa-feira</option>
              <option value="3">Quarta-feira</option>
              <option value="4">Quinta-feira</option>
              <option value="5">Sexta-feira</option>
              <option value="6">S√°bado</option>
            </select>
          </div>
        </div>

        <div class="form-grid" id="monthly-options" style="display: none;">
          <div class="form-group">
            <label for="schedule-day">Dia do M√™s</label>
            <input type="number" id="schedule-day" min="1" max="31" value="1">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="schedule-instances">Inst√¢ncias *</label>
            <input type="number" id="schedule-instances" min="1" max="12" value="1" required>
            <small>N√∫mero de janelas simult√¢neas</small>
          </div>

          <div class="form-group">
            <label for="schedule-referral">Link de Indica√ß√£o</label>
            <select id="schedule-referral">
              <option value="">Sem link</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="schedule-active" checked style="width: auto; margin-right: 8px;">
            Agendamento ativo
          </label>
        </div>

        <input type="hidden" id="schedule-id">

        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" onclick="closeScheduleModal()">Cancelar</button>
          <button type="submit" class="btn btn-save">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="notifications.js"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>
  <script src="router.js"></script>

  <script>
    let currentUser = null;
    let schedules = [];
    let macros = [];
    let referralLinks = [];

    // Inicializar
    async function init() {
      currentUser = await requirePagePermission("scheduler");
      if (!currentUser) return;

      await loadMacros();
      await loadReferralLinks();
      await loadSchedules();

      // Verificar agendamentos a cada minuto
      setInterval(checkSchedules, 60000);
    }

    // Carregar macros
    async function loadMacros() {
      try {
        const { data, error } = await supabaseClient
          .from('macros')
          .select('*')
          .eq('user_id', currentUser.id)
          .eq('enabled', true)
          .order('name');

        if (error) throw error;

        macros = data || [];

        const select = document.getElementById('schedule-macro');
        select.innerHTML = '<option value="">Selecione um macro</option>';
        macros.forEach(macro => {
          const option = document.createElement('option');
          option.value = macro.id;
          option.textContent = macro.name;
          select.appendChild(option);
        });

      } catch (error) {
        console.error('Erro ao carregar macros:', error);
      }
    }

    // Carregar links de indica√ß√£o
    async function loadReferralLinks() {
      try {
        const { data, error } = await supabaseClient
          .from('referral_links')
          .select('*')
          .eq('user_id', currentUser.id)
          .eq('is_active', true)
          .order('priority', { ascending: false });

        if (error) throw error;

        referralLinks = data || [];

        const select = document.getElementById('schedule-referral');
        select.innerHTML = '<option value="">Sem link</option>';
        referralLinks.forEach(link => {
          const option = document.createElement('option');
          option.value = link.id;
          option.textContent = link.platform;
          select.appendChild(option);
        });

      } catch (error) {
        console.error('Erro ao carregar links:', error);
      }
    }

    // Carregar agendamentos
    async function loadSchedules() {
      try {
        const { data, error } = await supabaseClient
          .from('scheduled_executions')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        schedules = data || [];
        renderSchedules();

      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
      }
    }

    // Renderizar agendamentos
    function renderSchedules() {
      const container = document.getElementById('schedules-grid');

      if (schedules.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <h3>Nenhum agendamento configurado</h3>
            <p>Clique em "Novo Agendamento" para come√ßar</p>
          </div>
        `;
        return;
      }

      const frequencyLabels = {
        once: 'Uma vez',
        daily: 'Di√°rio',
        weekly: 'Semanal',
        monthly: 'Mensal'
      };

      container.innerHTML = schedules.map(schedule => {
        const macro = macros.find(m => m.id === schedule.macro_id);
        const isActive = schedule.is_active !== false;

        return `
          <div class="schedule-card ${isActive ? 'active' : 'paused'}">
            <div class="schedule-header">
              <div class="schedule-title">
                <h3>${schedule.name}</h3>
                <p>${macro ? macro.name : 'Macro n√£o encontrado'}</p>
              </div>
              <span class="schedule-status ${isActive ? 'status-active' : 'status-paused'}">
                ${isActive ? 'Ativo' : 'Pausado'}
              </span>
            </div>

            <div class="schedule-details">
              <div class="detail-item">
                <div class="detail-icon">üìÖ</div>
                <div class="detail-info">
                  <label>Frequ√™ncia</label>
                  <span>${frequencyLabels[schedule.frequency]}</span>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">‚è∞</div>
                <div class="detail-info">
                  <label>Hor√°rio</label>
                  <span>${schedule.scheduled_time || 'N/A'}</span>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">üñ•Ô∏è</div>
                <div class="detail-info">
                  <label>Inst√¢ncias</label>
                  <span>${schedule.instances_count || 1}</span>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">üìä</div>
                <div class="detail-info">
                  <label>Execu√ß√µes</label>
                  <span>${schedule.execution_count || 0}</span>
                </div>
              </div>
            </div>

            <div class="schedule-actions">
              ${isActive
                ? `<button class="btn btn-pause" onclick="toggleSchedule('${schedule.id}', false)">‚è∏Ô∏è Pausar</button>`
                : `<button class="btn btn-play" onclick="toggleSchedule('${schedule.id}', true)">‚ñ∂Ô∏è Ativar</button>`
              }
              <button class="btn btn-edit" onclick="editSchedule('${schedule.id}')">‚úèÔ∏è Editar</button>
              <button class="btn btn-delete" onclick="deleteSchedule('${schedule.id}')">üóëÔ∏è Excluir</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Atualizar op√ß√µes de frequ√™ncia
    function updateFrequencyOptions() {
      const frequency = document.getElementById('schedule-frequency').value;

      document.getElementById('weekly-options').style.display =
        frequency === 'weekly' ? 'grid' : 'none';

      document.getElementById('monthly-options').style.display =
        frequency === 'monthly' ? 'grid' : 'none';
    }

    // Abrir modal
    function openScheduleModal() {
      document.getElementById('modal-title').textContent = '‚è∞ Novo Agendamento';
      document.getElementById('schedule-form').reset();
      document.getElementById('schedule-id').value = '';
      document.getElementById('schedule-active').checked = true;
      document.getElementById('schedule-modal').classList.add('active');
      updateFrequencyOptions();
    }

    // Fechar modal
    function closeScheduleModal() {
      document.getElementById('schedule-modal').classList.remove('active');
    }

    // Salvar agendamento
    async function saveSchedule(event) {
      event.preventDefault();

      const scheduleId = document.getElementById('schedule-id').value;
      const scheduleData = {
        user_id: currentUser.id,
        name: document.getElementById('schedule-name').value,
        macro_id: document.getElementById('schedule-macro').value,
        frequency: document.getElementById('schedule-frequency').value,
        scheduled_time: document.getElementById('schedule-time').value,
        weekday: document.getElementById('schedule-weekday').value,
        day_of_month: parseInt(document.getElementById('schedule-day').value),
        instances_count: parseInt(document.getElementById('schedule-instances').value),
        referral_link_id: document.getElementById('schedule-referral').value || null,
        is_active: document.getElementById('schedule-active').checked
      };

      try {
        if (scheduleId) {
          // Atualizar
          const { error } = await supabaseClient
            .from('scheduled_executions')
            .update(scheduleData)
            .eq('id', scheduleId);

          if (error) throw error;
          showNotification('‚úÖ Agendamento atualizado!', 'success');
        } else {
          // Criar novo
          scheduleData.execution_count = 0;
          scheduleData.last_execution = null;

          const { error } = await supabaseClient
            .from('scheduled_executions')
            .insert([scheduleData]);

          if (error) throw error;
          showNotification('‚úÖ Agendamento criado!', 'success');
        }

        closeScheduleModal();
        await loadSchedules();

      } catch (error) {
        console.error('Erro ao salvar agendamento:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    // Editar agendamento
    function editSchedule(id) {
      const schedule = schedules.find(s => s.id === id);
      if (!schedule) return;

      document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar Agendamento';
      document.getElementById('schedule-id').value = id;
      document.getElementById('schedule-name').value = schedule.name;
      document.getElementById('schedule-macro').value = schedule.macro_id;
      document.getElementById('schedule-frequency').value = schedule.frequency;
      document.getElementById('schedule-time').value = schedule.scheduled_time;
      document.getElementById('schedule-weekday').value = schedule.weekday || 0;
      document.getElementById('schedule-day').value = schedule.day_of_month || 1;
      document.getElementById('schedule-instances').value = schedule.instances_count || 1;
      document.getElementById('schedule-referral').value = schedule.referral_link_id || '';
      document.getElementById('schedule-active').checked = schedule.is_active !== false;

      updateFrequencyOptions();
      document.getElementById('schedule-modal').classList.add('active');
    }

    // Alternar status do agendamento
    async function toggleSchedule(id, newStatus) {
      try {
        const { error } = await supabaseClient
          .from('scheduled_executions')
          .update({ is_active: newStatus })
          .eq('id', id);

        if (error) throw error;

        showNotification(`‚úÖ Agendamento ${newStatus ? 'ativado' : 'pausado'}`, 'success');
        await loadSchedules();

      } catch (error) {
        console.error('Erro ao alterar agendamento:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    // Excluir agendamento
    async function deleteSchedule(id) {
      if (!confirm('Confirma a exclus√£o deste agendamento?')) return;

      try {
        const { error } = await supabaseClient
          .from('scheduled_executions')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showNotification('‚úÖ Agendamento exclu√≠do', 'success');
        await loadSchedules();

      } catch (error) {
        console.error('Erro ao excluir agendamento:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    // Verificar agendamentos (executar macros agendados)
    async function checkSchedules() {
      // Esta fun√ß√£o ser√° chamada a cada minuto
      // Aqui voc√™ implementaria a l√≥gica para verificar se h√° agendamentos para executar
      console.log('Verificando agendamentos...');

      const now = new Date();
      const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

      for (const schedule of schedules) {
        if (!schedule.is_active) continue;

        const shouldExecute = checkShouldExecute(schedule, now, currentTime);

        if (shouldExecute) {
          console.log('Executando agendamento:', schedule.name);
          // Aqui voc√™ chamaria a fun√ß√£o de execu√ß√£o do macro
          // await executeScheduledMacro(schedule);
        }
      }
    }

    // Verificar se deve executar um agendamento
    function checkShouldExecute(schedule, now, currentTime) {
      if (schedule.scheduled_time !== currentTime) return false;

      switch (schedule.frequency) {
        case 'daily':
          return true;

        case 'weekly':
          return now.getDay() === parseInt(schedule.weekday);

        case 'monthly':
          return now.getDate() === parseInt(schedule.day_of_month);

        case 'once':
          // Executar apenas se nunca foi executado
          return !schedule.last_execution;

        default:
          return false;
      }
    }

    // Fechar modal ao clicar fora
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('schedule-modal').addEventListener('click', (e) => {
        if (e.target.id === 'schedule-modal') {
          closeScheduleModal();
        }
      });
    });

    init();
  </script>
</body>
</html>
