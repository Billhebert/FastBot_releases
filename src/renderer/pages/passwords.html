<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Contas</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="menu-container"></div>

    <div class="workspace">
      <header class="workspace-header">
        <div>
          <p class="title">Contas Registradas</p>
          <p class="meta">Tudo que seus macros finalizaram fica salvo automaticamente aqui.</p>
        </div>
        <div class="header-actions">
          <button class="btn-ghost" type="button" onclick="loadAccounts()">Atualizar lista</button>
        </div>
      </header>

      <div class="panels-grid">
        <section class="panel">
          <div class="panel-header">
            <strong>Resumo</strong>
            <span class="meta">Ultima sincronizacao automatica</span>
          </div>
          <div class="account-stats">
            <div class="stat-card">
              <p>Total de contas</p>
              <strong id="accounts-total">0</strong>
            </div>
            <div class="stat-card">
              <p>Ultima conta</p>
              <strong id="accounts-last">-</strong>
            </div>
            <div class="stat-card">
              <p>Com proxy</p>
              <strong id="accounts-proxy">0</strong>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <strong>Contas</strong>
            <span class="meta" id="accounts-count">0 itens</span>
          </div>

          <div class="form-group">
            <label>Buscar</label>
            <input
              type="text"
              id="search-account"
              placeholder="Buscar por macro, email ou perfil..."
              onkeyup="filterAccounts()"
            />
          </div>

          <div id="accounts-container">Carregando...</div>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="notifications.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>

    <script>
      let currentUser = null;
      let allAccounts = [];

      async function init() {
        currentUser = await requirePagePermission("passwords");
        if (!currentUser) return;
        document.getElementById("menu-container").innerHTML = createMenu(currentUser);
        await loadAccounts();
      }

      async function loadAccounts() {
        const container = document.getElementById("accounts-container");
        container.innerHTML = "<p>Carregando...</p>";

        try {
          const { data, error } = await supabaseClient
            .from("registrations")
            .select("*")
            .eq("user_id", currentUser.id)
            .order("created_at", { ascending: false });

          if (error) throw error;

          allAccounts = data || [];
          updateSummary();
          displayAccounts(allAccounts);
        } catch (error) {
          container.innerHTML = "<p>Erro ao carregar contas</p>";
          showNotification("Erro ao carregar contas: " + error.message, "error");
        }
      }

      function updateSummary() {
        const total = allAccounts.length;
        const proxyCount = allAccounts.filter((acc) => acc.proxy_host).length;
        const last = allAccounts[0]?.created_at
          ? formatDate(allAccounts[0].created_at)
          : "-";

        document.getElementById("accounts-total").textContent = total;
        document.getElementById("accounts-proxy").textContent = proxyCount;
        document.getElementById("accounts-last").textContent = last;
        const countLabel = document.getElementById("accounts-count");
        if (countLabel) {
          countLabel.textContent = `${total} conta${total === 1 ? "" : "s"}`;
        }
      }

      function displayAccounts(accounts) {
        const container = document.getElementById("accounts-container");

        if (!accounts || accounts.length === 0) {
          container.innerHTML = "<p>Nenhuma conta registrada ainda.</p>";
          return;
        }

        container.innerHTML = accounts
          .map((account) => renderAccountCard(account))
          .join("");
      }

      function renderAccountCard(account) {
        const profile = buildProfile(account);
        const linkLabel = formatLinkLabel(account);
        const linkValue = account.notes || account.site_label || account.macro_name || "";
        const email = escapeHtml(account.email || "-");
        const password = escapeHtml(account.password_value || "-");

        return `
          <div class="account-card">
            <div class="account-card-header">
              <div>
                <strong>${escapeHtml(account.macro_name || "Macro desconhecido")}</strong>
                <span class="badge">${escapeHtml(account.device_type || "desktop")}</span>
              </div>
              <span class="account-date">${formatDate(account.created_at)}</span>
            </div>

            <div class="account-grid">
              <div>
                <label>Perfil</label>
                <p>${profile}</p>
              </div>
              <div>
                <label>Link / URL</label>
                <div class="field-inline">
                  <span>${linkLabel}</span>
                  <button type="button" data-value="${encodeURIComponent(linkValue || "")}" onclick="copyFromButton(this, 'Link')">Copiar</button>
                </div>
              </div>
              <div>
                <label>Email</label>
                <div class="field-inline">
                  <span>${email}</span>
                  <button type="button" data-value="${encodeURIComponent(account.email || "")}" onclick="copyFromButton(this, 'Email')">Copiar</button>
                </div>
              </div>
              <div>
                <label>Senha</label>
                <div class="field-inline">
                  <span>${password}</span>
                  <button type="button" data-value="${encodeURIComponent(account.password_value || "")}" onclick="copyFromButton(this, 'Senha')">Copiar</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function buildProfile(account) {
        const proxy = account.proxy_host
          ? `${account.proxy_host}:${account.proxy_port || ""}`
          : "Sem proxy";
        const device = account.device_type || "desktop";
        const profileLabel = account.site_label || account.macro_name || "Perfil";
        const segments = [
          escapeHtml(profileLabel),
          `Proxy: ${escapeHtml(proxy)}`,
          `Device: ${escapeHtml(device)}`,
        ];
        if (typeof account.instance_index === "number") {
          segments.push(`Janela ${account.instance_index + 1}`);
        }
        return segments.join(" | ");
      }

      function formatLinkLabel(account) {
        const raw = account.notes || account.site_label || account.macro_name || "-";
        return escapeHtml(raw).replace(/\n/g, "<br>");
      }

      function filterAccounts() {
        const term = document.getElementById("search-account").value.toLowerCase();
        const filtered = allAccounts.filter((acc) => {
          const haystack = [
            acc.macro_name,
            acc.site_label,
            acc.email,
            acc.proxy_host,
            acc.device_type,
            acc.notes,
          ]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          return haystack.includes(term);
        });
        displayAccounts(filtered);
      }

      function copyFromButton(button, label) {
        const value = decodeURIComponent(button.dataset.value || "");
        if (!value) {
          showNotification(`Nada para copiar em ${label}`, "warning");
          return;
        }
        copyField(value, label);
      }

      function copyField(value, label) {
        navigator.clipboard
          .writeText(value)
          .then(() => {
            showNotification(`${label} copiado!`, "success");
          })
          .catch((err) => {
            showNotification("Erro ao copiar: " + err.message, "error");
          });
      }

      function formatDate(dateStr) {
        if (!dateStr) return "-";
        const date = new Date(dateStr);
        return `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
      }

      function escapeHtml(value) {
        if (!value) return "";
        return value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      init();
    </script>
  </body>
</html>
