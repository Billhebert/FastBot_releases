<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Senhas</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="menu-container"></div>

    <div class="container">
      <h1>Gerenciar Senhas</h1>

      <div class="add-form">
        <h3>Adicionar Senhas</h3>
        <div class="form-group">
          <label>Identificação/Rótulo:</label>
          <input
            type="text"
            id="password-label"
            placeholder="Ex: Senha do Instagram, Senha Padrão, etc."
          />
        </div>
        <div class="form-group">
          <label>Senhas (uma por linha):</label>
          <textarea
            id="passwords"
            placeholder="Cole as senhas aqui (uma por linha)&#10;&#10;Cada senha será cadastrada com o mesmo rótulo&#10;Use isso para cadastrar múltiplas senhas de uma vez"
            rows="6"
          ></textarea>
        </div>
        <button onclick="addPasswords()">Adicionar Senhas</button>
      </div>

      <div class="passwords-list">
        <h3>Senhas Cadastradas</h3>
        <div class="form-group">
          <input
            type="text"
            id="search-password"
            placeholder="Buscar por rótulo..."
            onkeyup="filterPasswords()"
          />
        </div>
        <div id="passwords-container">Carregando...</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="notifications.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>

    <script>
      let allPasswords = [];
      let currentUser = null;

      async function init() {
        currentUser = await requirePagePermission("passwords");
        if (!currentUser) return;
        document.getElementById("menu-container").innerHTML = createMenu();
        await loadPasswords();
      }

      async function loadPasswords() {
        try {
          const { data, error } = await supabaseClient
            .from("passwords")
            .select("*")
            .eq("user_id", currentUser.id)
            .order("created_at", { ascending: false });

          if (error) throw error;

          allPasswords = data || [];
          displayPasswords(allPasswords);
        } catch (error) {
          showNotification(
            "Erro ao carregar senhas: " + error.message,
            "error"
          );
        }
      }

      function displayPasswords(passwords) {
        const container = document.getElementById("passwords-container");

        if (!passwords || passwords.length === 0) {
          container.innerHTML = "<p>Nenhuma senha cadastrada</p>";
          return;
        }

        container.innerHTML = passwords
          .map(
            (pwd) => `
        <div class="password-item">
          <div>
            <strong>${pwd.label}</strong>
            <span id="pwd-${
              pwd.id
            }" style="font-family: monospace;">••••••••••••••••</span>
          </div>
          <div class="actions">
            <button onclick="togglePassword('${
              pwd.id
            }', '${pwd.password.replace(/'/g, "\\'")}')">
              <span id="btn-${pwd.id}">Ver</span>
            </button>
            <button onclick="copyPassword('${pwd.password.replace(
              /'/g,
              "\\'"
            )}')">Copiar</button>
            <button onclick="deletePassword('${pwd.id}')">Excluir</button>
          </div>
        </div>
      `
          )
          .join("");
      }

      function filterPasswords() {
        const search = document
          .getElementById("search-password")
          .value.toLowerCase();
        const filtered = allPasswords.filter((pwd) =>
          pwd.label.toLowerCase().includes(search)
        );
        displayPasswords(filtered);
      }

      async function addPasswords() {
        const label = document.getElementById("password-label").value.trim();
        const passwordsText = document.getElementById("passwords").value;

        if (!label) {
          showNotification("Digite uma identificação/rótulo", "warning");
          return;
        }

        if (!passwordsText.trim()) {
          showNotification("Digite pelo menos uma senha", "warning");
          return;
        }

        const passwords = passwordsText
          .split("\n")
          .map((p) => p.trim())
          .filter((p) => p);

        if (passwords.length === 0) {
          showNotification("Nenhuma senha válida encontrada", "warning");
          return;
        }

        try {
          const passwordsData = passwords.map((password) => ({
            label,
            password,
            user_id: currentUser.id,
          }));

          const { error } = await supabaseClient
            .from("passwords")
            .insert(passwordsData);

          if (error) throw error;

          document.getElementById("password-label").value = "";
          document.getElementById("passwords").value = "";
          showNotification(
            `${passwords.length} senha(s) adicionada(s)!`,
            "success"
          );
          await loadPasswords();
        } catch (error) {
          showNotification(
            "Erro ao adicionar senhas: " + error.message,
            "error"
          );
        }
      }

      function togglePassword(id, password) {
        const pwdSpan = document.getElementById(`pwd-${id}`);
        const btnSpan = document.getElementById(`btn-${id}`);

        if (pwdSpan.textContent === "••••••••••••••••") {
          pwdSpan.textContent = password;
          btnSpan.textContent = "Ocultar";
        } else {
          pwdSpan.textContent = "••••••••••••••••";
          btnSpan.textContent = "Ver";
        }
      }

      function copyPassword(password) {
        navigator.clipboard
          .writeText(password)
          .then(() => {
            showNotification("Senha copiada!", "success");
          })
          .catch((err) => {
            showNotification("Erro ao copiar: " + err.message, "error");
          });
      }

      async function deletePassword(id) {
        const confirmed = await confirm("Confirma exclusão desta senha?");
        if (!confirmed) return;

        try {
          const { error } = await supabaseClient
            .from("passwords")
            .delete()
            .eq("id", id)
            .eq("user_id", currentUser.id);

          if (error) throw error;

          showNotification("Senha excluída", "success");
          await loadPasswords();
        } catch (error) {
          showNotification("Erro ao excluir: " + error.message, "error");
        }
      }

      init();
    </script>
  </body>
</html>
