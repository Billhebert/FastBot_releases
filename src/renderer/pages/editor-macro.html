<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editor de Macro - Com TYPE</title>
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .editor-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      .actions-list {
        background: white;
        padding: 15px;
        border-radius: 8px;
        max-height: 600px;
        overflow-y: auto;
      }
      .action-item {
        background: #f8f9fa;
        padding: 12px;
        margin: 8px 0;
        border-radius: 5px;
        border-left: 4px solid #3498db;
        cursor: pointer;
        transition: all 0.2s;
      }
      .action-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
      }
      .action-item.selected {
        background: #d1ecf1;
        border-left-color: #0c5460;
      }
      .action-type {
        font-weight: bold;
        color: #2c3e50;
        text-transform: uppercase;
        font-size: 12px;
      }
      .action-detail {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .editor-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
      }
      .editor-panel h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }
      .form-field {
        margin-bottom: 15px;
      }
      .form-field label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 13px;
      }
      .form-field input,
      .form-field textarea,
      .form-field select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
      }
      .form-field textarea {
        min-height: 80px;
        font-family: monospace;
      }
      .variable-buttons {
        display: flex;
        gap: 5px;
        margin-top: 5px;
        flex-wrap: wrap;
      }
      .var-btn {
        padding: 5px 10px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        width: auto;
      }
      .var-btn:hover {
        background: #5a6268;
      }
      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-save {
        background: #28a745;
      }
      .btn-delete {
        background: #dc3545;
      }
      .btn-add {
        background: #007bff;
        margin-top: 10px;
        width: 100%;
      }
      .action-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }
      .btn-move {
        padding: 3px 8px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        width: auto;
      }
      .loop-indicator {
        background: #ffc107;
        color: #000;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-left: 5px;
      }
      .condition-indicator {
        background: #17a2b8;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-left: 5px;
      }
      .type-indicator {
        background: #667eea;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-left: 5px;
      }
      .macro-toolbar {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .macro-info {
        flex: 1;
      }
      .macro-actions {
        display: flex;
        gap: 10px;
      }
      .add-action-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }
      .add-action-modal.show {
        display: flex;
      }
      .add-action-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 700px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .action-type-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .action-type-btn {
        padding: 15px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
      }
      .action-type-btn:hover {
        background: #e9ecef;
        border-color: #3498db;
        transform: translateY(-2px);
      }
      .action-type-btn strong {
        display: block;
        color: #2c3e50;
        margin-bottom: 5px;
      }
      .action-type-btn small {
        color: #666;
        font-size: 11px;
      }
      .action-type-btn.type-action {
        background: linear-gradient(135deg, #1b2a37 0%, #28648c 100%);
        border-color: #28648c;
      }
      .action-type-btn.type-action strong {
        color: white;
      }
      .action-type-btn.type-action small {
        color: rgba(255, 255, 255, 0.95);
      }
      .action-type-btn.type-action:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      .help-text {
        background: #e7f3ff;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 12px;
        color: #0c5460;
        border-left: 4px solid #0c5460;
      }
      .help-text strong {
        display: block;
        margin-bottom: 5px;
      }
      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 600;
      }
      .checkbox-label input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="menu-container"></div>

    <div class="container">
      <h1>Editor de Macro</h1>

      <div class="macro-toolbar">
        <div class="macro-info">
          <strong id="macro-name">Carregando...</strong><br />
          <small id="macro-device"></small>
        </div>
        <div class="macro-actions">
          <button onclick="showAddActionModal()" class="btn-add">
            Adicionar Acao
          </button>
          <button onclick="saveAllChanges()" style="background: #28a745">
            Salvar Tudo
          </button>
          <button onclick="goBack()" style="background: #6c757d">Voltar</button>
        </div>
      </div>

      <div class="editor-container">
        <div class="actions-list">
          <h3>Acoes do Macro</h3>
          <div id="actions-container"></div>
        </div>

        <div class="editor-panel">
          <h3>Editar Acao</h3>
          <div id="editor-form">
            <p style="color: #999; text-align: center">
              Selecione uma acao a esquerda
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="add-action-modal" class="add-action-modal">
      <div class="add-action-content">
        <h2>Selecione o tipo de acao</h2>
        <div class="action-type-grid">
          <div class="action-type-btn type-action" onclick="addAction('type')">
            <strong>⌨️ TYPE</strong>
            <small>Digita sem seletor<br />(use coordenadas!)</small>
          </div>
          <div class="action-type-btn" onclick="addAction('click')">
            <strong>Click</strong>
            <small>Clicar em elemento</small>
          </div>
          <div class="action-type-btn" onclick="addAction('input')">
            <strong>Input</strong>
            <small>Digitar com seletor</small>
          </div>
          <div class="action-type-btn" onclick="addAction('navigate')">
            <strong>Navigate</strong>
            <small>Navegar para URL</small>
          </div>
          <div class="action-type-btn" onclick="addAction('scroll')">
            <strong>Scroll</strong>
            <small>Rolar pagina</small>
          </div>
          <div class="action-type-btn" onclick="addAction('keypress')">
            <strong>Keypress</strong>
            <small>Pressionar tecla</small>
          </div>
          <div class="action-type-btn" onclick="addAction('wait')">
            <strong>Wait</strong>
            <small>Aguardar tempo</small>
          </div>
          <div class="action-type-btn" onclick="addAction('loop')">
            <strong>Loop</strong>
            <small>Repetir acoes</small>
          </div>
          <div class="action-type-btn" onclick="addAction('condition')">
            <strong>Condition</strong>
            <small>If/Else</small>
          </div>
        </div>
        <button
          onclick="hideAddActionModal()"
          style="margin-top: 20px; background: #6c757d; width: 100%"
        >
          Cancelar
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="notifications.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>

    <script>
      let currentMacro = null;
      let actions = [];
      let selectedIndex = null;
      let currentUser = null;

      async function init() {
        currentUser = await requirePagePermission("macros");
        if (!currentUser) return;
        document.getElementById("menu-container").innerHTML = createMenu();
        await loadMacro();
      }

      function goBack() {
        window.location.href = "macros.html";
      }

      function showAddActionModal() {
        document.getElementById("add-action-modal").classList.add("show");
      }

      function hideAddActionModal() {
        document.getElementById("add-action-modal").classList.remove("show");
      }

      async function loadMacro() {
        const params = new URLSearchParams(window.location.search);
        const macroId = params.get("id");

        if (!macroId) {
          showNotification("ID do macro nao fornecido", "error");
          setTimeout(goBack, 1200);
          return;
        }

        try {
          const { data, error } = await supabaseClient
            .from("macros")
            .select("*")
            .eq("id", macroId)
            .single();

          if (error || !data) throw error || new Error("Macro nao encontrado");

          currentMacro = data;
          actions = JSON.parse(data.actions || "[]");

          document.getElementById("macro-name").textContent = data.name;
          document.getElementById(
            "macro-device"
          ).textContent = `Device: ${data.device}`;

          renderActionsList();
        } catch (error) {
          console.error("Erro ao carregar macro:", error);
          showNotification("Erro ao carregar macro", "error");
          setTimeout(goBack, 1200);
        }
      }

      function addAction(type) {
        const newAction = { type };

        switch (type) {
          case "type":
            newAction.x = 100;
            newAction.y = 100;
            newAction.value = "";
            newAction.delay = 300;
            newAction.click = true;
            newAction.clear = true;
            newAction.typeSpeed = null;
            break;
          case "click":
            newAction.selector = "";
            newAction.x = 0;
            newAction.y = 0;
            break;
          case "input":
            newAction.selector = "";
            newAction.value = "";
            break;
          case "navigate":
            newAction.url = "";
            break;
          case "scroll":
            newAction.scrollY = 0;
            newAction.scrollX = 0;
            break;
          case "keypress":
            newAction.key = "Enter";
            break;
          case "wait":
            newAction.duration = 1000;
            break;
          case "loop":
            newAction.times = 2;
            newAction.actions = [];
            break;
          case "condition":
            newAction.condition = "element_exists";
            newAction.selector = "";
            newAction.then = [];
            newAction.else = [];
            break;
        }

        actions.push(newAction);
        hideAddActionModal();
        selectedIndex = actions.length - 1;
        renderActionsList();
        renderEditor();
      }

      function renderActionsList() {
        const container = document.getElementById("actions-container");

        if (actions.length === 0) {
          container.innerHTML =
            '<p style="color: #999; text-align: center;">Nenhuma acao</p>';
          return;
        }

        container.innerHTML = actions
          .map((action, index) => {
            let detail = "";
            let indicators = "";

            switch (action.type) {
              case "type":
                let typeDetail = "";
                if (action.click !== false) {
                  typeDetail = `(${action.x}, ${action.y}) → `;
                } else {
                  typeDetail = "(sem clicar) → ";
                }
                typeDetail += `"${(action.value || "").substring(0, 25)}..."`;
                if (action.clear === false) {
                  typeDetail += " [adiciona]";
                }
                detail = typeDetail;
                indicators = '<span class="type-indicator">TYPE</span>';
                break;
              case "click":
                detail = action.selector || `(${action.x}, ${action.y})`;
                break;
              case "input":
                detail = `${action.selector} = ${(action.value || "").substring(
                  0,
                  30
                )}`;
                break;
              case "navigate":
                detail = action.url || "";
                break;
              case "scroll":
                detail = `Y: ${action.scrollY}`;
                break;
              case "keypress":
                detail = action.key || "";
                break;
              case "loop":
                detail = `Repetir ${action.times}x`;
                indicators = '<span class="loop-indicator">LOOP</span>';
                break;
              case "condition":
                detail = action.condition || "";
                indicators = '<span class="condition-indicator">IF</span>';
                break;
              case "wait":
                detail = `${action.duration}ms`;
                break;
              default:
                detail = JSON.stringify(action).substring(0, 40);
            }

            return `
                    <div class="action-item ${
                      selectedIndex === index ? "selected" : ""
                    }" onclick="selectAction(${index})">
                        <div class="action-type">${index + 1}. ${
              action.type
            }${indicators}</div>
                        <div class="action-detail">${detail}</div>
                        <div class="action-controls">
                            <div>
                                <button class="btn-move" onclick="moveAction(${index}, -1); event.stopPropagation();">▲</button>
                                <button class="btn-move" onclick="moveAction(${index}, 1); event.stopPropagation();">▼</button>
                            </div>
                            <button class="btn-move" style="background: #dc3545;" onclick="deleteActionConfirm(${index}); event.stopPropagation();">Excluir</button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function selectAction(index) {
        selectedIndex = index;
        renderActionsList();
        renderEditor();
      }

      function renderEditor() {
        const container = document.getElementById("editor-form");

        if (selectedIndex === null || !actions[selectedIndex]) {
          container.innerHTML =
            '<p style="color: #999; text-align: center;">Selecione uma acao</p>';
          return;
        }

        const action = actions[selectedIndex];
        let html = "";

        switch (action.type) {
          case "type":
            html = `
                        <div class="help-text">
                            <strong>⌨️ TYPE - Digitar com controle total</strong>
                            Digita nas coordenadas X,Y sem precisar de seletor CSS. Configure se quer clicar antes, limpar campo, e velocidade de digitacao.
                        </div>
                        
                        <div class="form-field">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-click" ${
                                  action.click !== false ? "checked" : ""
                                } 
                                       onchange="toggleCoordinates()">
                                <span>Clicar antes de digitar?</span>
                            </label>
                            <small style="color: #666; margin-left: 24px;">Desmarque se o campo ja estiver focado (ex: apos Tab)</small>
                        </div>
                        
                        <div id="coordinates-section" style="${
                          action.click !== false ? "" : "display: none;"
                        }">
                            <div class="form-field">
                                <label>Posicao X:</label>
                                <input type="number" id="edit-x" value="${
                                  action.x || 0
                                }">
                            </div>
                            <div class="form-field">
                                <label>Posicao Y:</label>
                                <input type="number" id="edit-y" value="${
                                  action.y || 0
                                }">
                            </div>
                            <div class="form-field">
                                <label>Delay apos clicar (ms):</label>
                                <input type="number" id="edit-delay" value="${
                                  action.delay || 300
                                }" step="50">
                                <small style="color: #666;">Tempo de espera apos clicar, antes de comecar a digitar</small>
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label class="checkbox-label">
                                <input type="checkbox" id="edit-clear" ${
                                  action.clear !== false ? "checked" : ""
                                }>
                                <span>Limpar campo antes de digitar?</span>
                            </label>
                            <small style="color: #666; margin-left: 24px;">Desmarque para adicionar texto ao final (nao apaga o que ja esta la)</small>
                        </div>
                        
                        <div class="form-field">
                            <label>Texto para digitar:</label>
                            <textarea id="edit-value">${
                              action.value || ""
                            }</textarea>
                            <div class="variable-buttons">
                                <button class="var-btn" onclick="insertVariable('{{email}}')">+ {{email}}</button>
                                <button class="var-btn" onclick="insertVariable('{{password}}')">+ {{password}}</button>
                                <button class="var-btn" onclick="insertVariable('{{pix}}')">+ {{pix}}</button>
                                <button class="var-btn" onclick="insertVariable('{{username}}')">+ {{username}}</button>
                                <button class="var-btn" onclick="insertVariable('{{phone}}')">+ {{phone}}</button>
                            </div>
                            <small style="color:#666;">Vari&aacute;veis: {{email}}, {{password}}, {{pix}}, {{username}}, {{phone}}</small>
                        </div>
                        
                        <div class="form-field">
                            <label>Velocidade de digitacao:</label>
                            <select id="edit-typeSpeed">
                                <option value="null" ${
                                  !action.typeSpeed ? "selected" : ""
                                }>Aleatoria (50-150ms) - Mais humano</option>
                                <option value="20" ${
                                  action.typeSpeed === 20 ? "selected" : ""
                                }>Muito rapido (20ms)</option>
                                <option value="50" ${
                                  action.typeSpeed === 50 ? "selected" : ""
                                }>Rapido (50ms)</option>
                                <option value="100" ${
                                  action.typeSpeed === 100 ? "selected" : ""
                                }>Normal (100ms)</option>
                                <option value="200" ${
                                  action.typeSpeed === 200 ? "selected" : ""
                                }>Lento (200ms)</option>
                                <option value="300" ${
                                  action.typeSpeed === 300 ? "selected" : ""
                                }>Muito lento (300ms)</option>
                            </select>
                            <small style="color: #666;">Tempo entre cada tecla. Aleatorio e mais realista.</small>
                        </div>
                    `;
            break;

          case "click":
            html = `
                        <div class="form-field">
                            <label>Seletor:</label>
                            <input type="text" id="edit-selector" value="${
                              action.selector || ""
                            }" placeholder="#id ou .class">
                        </div>
                        <div class="form-field">
                            <label>Posicao X:</label>
                            <input type="number" id="edit-x" value="${
                              action.x || 0
                            }">
                        </div>
                        <div class="form-field">
                            <label>Posicao Y:</label>
                            <input type="number" id="edit-y" value="${
                              action.y || 0
                            }">
                        </div>
                    `;
            break;

          case "input":
            html = `
                        <div class="form-field">
                            <label>Seletor:</label>
                            <input type="text" id="edit-selector" value="${
                              action.selector || ""
                            }" placeholder="#id ou .class">
                        </div>
                        <div class="form-field">
                            <label>Valor:</label>
                            <textarea id="edit-value">${
                              action.value || ""
                            }</textarea>
                            <div class="variable-buttons">
                                <button class="var-btn" onclick="insertVariable('{{email}}')">+ {{email}}</button>
                                <button class="var-btn" onclick="insertVariable('{{password}}')">+ {{password}}</button>
                                <button class="var-btn" onclick="insertVariable('{{pix}}')">+ {{pix}}</button>
                                <button class="var-btn" onclick="insertVariable('{{username}}')">+ {{username}}</button>
                                <button class="var-btn" onclick="insertVariable('{{phone}}')">+ {{phone}}</button>
                            </div>
                            <small style="color:#666;">Dispon&iacute;veis: {{email}}, {{password}}, {{pix}}, {{username}}, {{phone}}</small>
                        </div>
                    `;
            break;

          case "navigate":
            html = `
                        <div class="form-field">
                            <label>URL:</label>
                            <input type="text" id="edit-url" value="${
                              action.url || ""
                            }" placeholder="https://...">
                        </div>
                    `;
            break;

          case "scroll":
            html = `
                        <div class="form-field">
                            <label>Scroll Y:</label>
                            <input type="number" id="edit-scrollY" value="${
                              action.scrollY || 0
                            }">
                        </div>
                        <div class="form-field">
                            <label>Scroll X:</label>
                            <input type="number" id="edit-scrollX" value="${
                              action.scrollX || 0
                            }">
                        </div>
                    `;
            break;

          case "keypress":
            html = `
                        <div class="form-field">
                            <label>Tecla:</label>
                            <select id="edit-key">
                                <option value="Enter" ${
                                  action.key === "Enter" ? "selected" : ""
                                }>Enter</option>
                                <option value="Tab" ${
                                  action.key === "Tab" ? "selected" : ""
                                }>Tab</option>
                                <option value="Escape" ${
                                  action.key === "Escape" ? "selected" : ""
                                }>Escape</option>
                                <option value="Backspace" ${
                                  action.key === "Backspace" ? "selected" : ""
                                }>Backspace</option>
                                <option value="ArrowUp" ${
                                  action.key === "ArrowUp" ? "selected" : ""
                                }>Seta Cima</option>
                                <option value="ArrowDown" ${
                                  action.key === "ArrowDown" ? "selected" : ""
                                }>Seta Baixo</option>
                            </select>
                        </div>
                    `;
            break;

          case "wait":
            html = `
                        <div class="form-field">
                            <label>Duracao (ms):</label>
                            <input type="number" id="edit-duration" value="${
                              action.duration || 1000
                            }" step="100">
                        </div>
                    `;
            break;

          case "loop":
            html = `
                        <div class="form-field">
                            <label>Numero de repeticoes:</label>
                            <input type="number" id="edit-times" value="${
                              action.times || 2
                            }" min="1">
                        </div>
                        <div class="form-field">
                            <label>Acoes do loop (JSON):</label>
                            <textarea id="edit-actions" style="min-height: 150px;">${JSON.stringify(
                              action.actions || [],
                              null,
                              2
                            )}</textarea>
                            <small>Exemplo: [{"type": "click", "selector": ".next"}]</small>
                        </div>
                    `;
            break;

          case "condition":
            html = `
                        <div class="form-field">
                            <label>Condicao:</label>
                            <select id="edit-condition">
                                <option value="element_exists" ${
                                  action.condition === "element_exists"
                                    ? "selected"
                                    : ""
                                }>Elemento existe</option>
                                <option value="element_not_exists" ${
                                  action.condition === "element_not_exists"
                                    ? "selected"
                                    : ""
                                }>Elemento nao existe</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Seletor:</label>
                            <input type="text" id="edit-selector" value="${
                              action.selector || ""
                            }" placeholder="#id ou .class">
                        </div>
                        <div class="form-field">
                            <label>Se verdadeiro (JSON):</label>
                            <textarea id="edit-then" style="min-height: 100px;">${JSON.stringify(
                              action.then || [],
                              null,
                              2
                            )}</textarea>
                        </div>
                        <div class="form-field">
                            <label>Se falso (JSON):</label>
                            <textarea id="edit-else" style="min-height: 100px;">${JSON.stringify(
                              action.else || [],
                              null,
                              2
                            )}</textarea>
                        </div>
                    `;
            break;

          default:
            html = `
                        <div class="form-field">
                            <label>JSON da acao:</label>
                            <textarea id="edit-json" style="min-height: 200px;">${JSON.stringify(
                              action,
                              null,
                              2
                            )}</textarea>
                        </div>
                    `;
        }

        html += `
                <div class="btn-group">
                    <button onclick="saveCurrentAction()" class="btn-save" style="flex: 1; padding: 12px;">Salvar Acao</button>
                    <button onclick="deleteActionConfirm(${selectedIndex})" class="btn-delete" style="padding: 12px;">Deletar</button>
                </div>
            `;

        container.innerHTML = html;
      }

      function toggleCoordinates() {
        const checkbox = document.getElementById("edit-click");
        const section = document.getElementById("coordinates-section");
        section.style.display = checkbox.checked ? "" : "none";
      }

      function insertVariable(variable) {
        const textarea = document.getElementById("edit-value");
        if (!textarea) return;

        const start = textarea.selectionStart || 0;
        const end = textarea.selectionEnd || 0;
        const text = textarea.value;

        textarea.value =
          text.substring(0, start) + variable + text.substring(end);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd =
          start + variable.length;
      }

      function saveCurrentAction() {
        if (selectedIndex === null) return;

        const action = actions[selectedIndex];

        try {
          switch (action.type) {
            case "type":
              action.click = document.getElementById("edit-click").checked;
              action.clear = document.getElementById("edit-clear").checked;
              action.value = document.getElementById("edit-value").value;

              if (action.click) {
                action.x =
                  parseInt(document.getElementById("edit-x").value) || 0;
                action.y =
                  parseInt(document.getElementById("edit-y").value) || 0;
                action.delay =
                  parseInt(document.getElementById("edit-delay").value) || 300;
              }

              const speedValue =
                document.getElementById("edit-typeSpeed").value;
              action.typeSpeed =
                speedValue === "null" ? null : parseInt(speedValue);
              break;

            case "click":
              action.selector = document.getElementById("edit-selector").value;
              action.x =
                parseInt(document.getElementById("edit-x").value, 10) || 0;
              action.y =
                parseInt(document.getElementById("edit-y").value, 10) || 0;
              break;

            case "input":
              action.selector = document.getElementById("edit-selector").value;
              action.value = document.getElementById("edit-value").value;
              break;

            case "navigate":
              action.url = document.getElementById("edit-url").value;
              break;

            case "scroll":
              action.scrollY =
                parseInt(document.getElementById("edit-scrollY").value, 10) ||
                0;
              action.scrollX =
                parseInt(document.getElementById("edit-scrollX").value, 10) ||
                0;
              break;

            case "keypress":
              action.key = document.getElementById("edit-key").value;
              break;

            case "wait":
              action.duration =
                parseInt(document.getElementById("edit-duration").value, 10) ||
                1000;
              break;

            case "loop":
              action.times =
                parseInt(document.getElementById("edit-times").value, 10) || 1;
              action.actions = JSON.parse(
                document.getElementById("edit-actions").value || "[]"
              );
              break;

            case "condition":
              action.condition =
                document.getElementById("edit-condition").value;
              action.selector = document.getElementById("edit-selector").value;
              action.then = JSON.parse(
                document.getElementById("edit-then").value || "[]"
              );
              action.else = JSON.parse(
                document.getElementById("edit-else").value || "[]"
              );
              break;

            default:
              const json = document.getElementById("edit-json").value;
              actions[selectedIndex] = JSON.parse(json);
          }

          renderActionsList();
          showNotification(
            'Acao salva! Nao esqueca de clicar em "Salvar Tudo"',
            "success"
          );
        } catch (error) {
          showNotification("Erro ao salvar: " + error.message, "error");
        }
      }

      async function saveAllChanges() {
        try {
          const { error } = await supabaseClient
            .from("macros")
            .update({ actions: JSON.stringify(actions) })
            .eq("id", currentMacro.id);

          if (error) throw error;

          showNotification("Macro salvo com sucesso!", "success");
          setTimeout(goBack, 1000);
        } catch (error) {
          showNotification("Erro ao salvar: " + error.message, "error");
        }
      }

      function deleteActionConfirm(index) {
        const confirmed = window.confirm(
          "Tem certeza que deseja deletar esta acao?"
        );
        if (!confirmed) return;
        deleteAction(index);
      }

      function deleteAction(index) {
        actions.splice(index, 1);
        selectedIndex = null;
        renderActionsList();
        renderEditor();
        showNotification(
          "Acao deletada! Salve o macro para confirmar",
          "warning"
        );
      }

      function moveAction(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= actions.length) return;

        const tmp = actions[index];
        actions[index] = actions[newIndex];
        actions[newIndex] = tmp;

        if (selectedIndex === index) selectedIndex = newIndex;
        else if (selectedIndex === newIndex) selectedIndex = index;

        renderActionsList();
      }

      init();
    </script>
  </body>
</html>
