<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Macros</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="menu-container"></div>

    <div class="workspace">
      <header class="workspace-header">
        <div>
          <p class="title" id="macro-header-title">Selecionar Macro</p>
          <p class="meta" id="macro-header-meta">
            Defina apenas o macro, o dispositivo e a quantidade de janelas. Todo o restante acontece automaticamente durante a execução.
          </p>
        </div>
        <div class="header-actions">
          <button class="btn-ghost" type="button" onclick="loadMacros()">Recarregar</button>
        </div>
      </header>

      <div class="panels-grid">
        <section class="panel" id="macro-preferences-panel">
          <div class="panel-header">
            <strong>Preferência</strong>
            <span class="meta">Usada na aba Jogar</span>
          </div>

          <div class="form-group">
            <label>Macro</label>
            <select id="macro-select" onchange="handleMacroChange()">
              <option value="">Carregando macros...</option>
            </select>
            <small class="helper-text" id="macro-details">Escolha um macro para ver detalhes.</small>
          </div>

          <div class="form-group">
            <label>Dispositivo</label>
            <select id="device-select">
              <option value="desktop">Desktop</option>
              <option value="mobile">Mobile</option>
            </select>
          </div>

          <div class="form-group">
            <label>Quantidade de janelas</label>
            <input type="number" id="window-count" value="1" min="1" max="12" />
            <small class="helper-text">Máximo de 12 janelas simultâneas.</small>
          </div>

          <label style="display:flex; gap:8px; align-items:center; font-size:13px; margin-bottom:12px;">
            <input type="checkbox" id="auto-save" checked />
            Manter preferências salvas automaticamente
          </label>

          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="btn-primary" type="button" onclick="savePreferences(false)">Salvar preferências</button>
            <button class="btn-ghost" id="goto-execute-btn" type="button" onclick="goToExecute()">Ir para Jogar</button>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <strong>Macros disponíveis</strong>
            <span class="meta" id="macro-count">0 macros</span>
          </div>
          <div id="dev-helper-card" class="dev-helper-card" style="display:none;">
            <p class="dev-helper-eyebrow">Modo DEV</p>
            <p>Use esta lista para criar ou editar macros. Clique em "Editar" para ajustar um macro existente ou inicie um novo abaixo.</p>
            <div class="dev-helper-actions">
              <label style="display:flex; flex-direction:column; gap:4px; font-size:13px;">
                <span>Dispositivo inicial</span>
                <select id="new-macro-device" style="padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:#1f1f2b; color:#fdfdfd;">
                  <option value="desktop">Desktop</option>
                  <option value="mobile">Mobile</option>
                </select>
              </label>
              <button class="btn-primary" type="button" onclick="createNewMacro()">Novo macro</button>
            </div>
          </div>
          <div id="macros-container">Carregando...</div>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="notifications.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>

    <script>
      const PREFS_KEY = "fastbot_macro_prefs";
      let currentUser = null;
      let macros = [];
      let isDevMode = false;
      let preferences = {
        macroId: "",
        device: "desktop",
        count: 1,
      };

      async function init() {
        currentUser = await requirePagePermission("macros");
        if (!currentUser) return;
        document.getElementById("menu-container").innerHTML = createMenu(currentUser);
        isDevMode = currentUser.role === "dev";
        applyRoleLayout();
        if (!isDevMode) {
          loadPreferences();
        }
        await loadMacros();
      }

      function applyRoleLayout() {
        const headerTitle = document.getElementById("macro-header-title");
        const headerMeta = document.getElementById("macro-header-meta");
        const prefPanel = document.getElementById("macro-preferences-panel");
        const goPlayBtn = document.getElementById("goto-execute-btn");
        const devHelper = document.getElementById("dev-helper-card");

        if (isDevMode) {
          if (headerTitle) headerTitle.textContent = "Criar e editar macros";
          if (headerMeta)
            headerMeta.textContent =
              "Visualize todos os macros e abra o editor para ajustar ou gravar novas acoes.";
          if (prefPanel) prefPanel.style.display = "none";
          if (goPlayBtn) goPlayBtn.style.display = "none";
          if (devHelper) devHelper.style.display = "block";
        } else {
          if (headerTitle) headerTitle.textContent = "Selecionar Macro";
          if (headerMeta)
            headerMeta.textContent =
              "Defina apenas o macro, o dispositivo e a quantidade de janelas. Todo o restante acontece automaticamente durante a execucao.";
          if (prefPanel) prefPanel.style.display = "";
          if (goPlayBtn) goPlayBtn.style.display = "";
          if (devHelper) devHelper.style.display = "none";
        }
      }

      async function createNewMacro() {
        if (!currentUser || currentUser.role !== "dev") {
          showNotification("Funcao disponivel apenas para DEV", "warning");
          return;
        }

        try {
          const timestamp = new Date().toLocaleString("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
          const baseName = `Macro ${timestamp}`;
          const deviceSelect = document.getElementById("new-macro-device");
          const deviceType = deviceSelect?.value === "mobile" ? "mobile" : "desktop";
          const { data, error } = await supabaseClient
            .from("macros")
            .insert({
              name: baseName,
              device_type: deviceType,
              actions: "[]",
              enabled: true,
              delay_min: 500,
              delay_max: 2000,
            })
            .select()
            .single();

          if (error) throw error;

          showNotification("Macro criado!", "success");
          window.location.href = `editor-macro.html?id=${data.id}`;
        } catch (error) {
          console.error("Erro ao criar macro:", error);
          showNotification("Erro ao criar macro: " + error.message, "error");
        }
      }

      function loadPreferences() {
        try {
          const stored = localStorage.getItem(PREFS_KEY);
          if (!stored) return;
          const parsed = JSON.parse(stored);
          preferences = {
            macroId: parsed.macroId || "",
            device: parsed.device || "desktop",
            count: parsed.count || 1,
          };
          document.getElementById("device-select").value = preferences.device;
          document.getElementById("window-count").value = preferences.count;
        } catch (error) {
          console.warn("Não foi possível carregar preferências de macro:", error);
        }
      }

      function savePreferences(silent) {
        preferences.device = document.getElementById("device-select").value;
        preferences.count = Math.max(
          1,
          Math.min(12, parseInt(document.getElementById("window-count").value, 10) || 1)
        );

        if (!preferences.macroId) {
          showNotification("Selecione um macro antes de salvar", "warning");
          return;
        }

        localStorage.setItem(PREFS_KEY, JSON.stringify(preferences));
        if (!silent) {
          showNotification("Preferências salvas!", "success");
        }
      }

      function goToExecute() {
        savePreferences(true);
        navigate("execute");
      }

      async function loadMacros() {
        const container = document.getElementById("macros-container");
        container.innerHTML = "<p>Carregando...</p>";

        try {
          const { data, error } = await supabaseClient
            .from("macros")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          macros = data || [];
          renderMacroList();
          populateMacroSelect();
        } catch (error) {
          container.innerHTML = "<p>Erro ao carregar macros</p>";
          showNotification("Erro ao carregar macros: " + error.message, "error");
        }
      }

      function renderMacroList() {
        const container = document.getElementById("macros-container");
        const counter = document.getElementById("macro-count");

        if (counter) {
          counter.textContent = `${macros.length} macro${macros.length === 1 ? "" : "s"}`;
        }

        if (!macros.length) {
          container.innerHTML = "<p>Nenhum macro cadastrado</p>";
          return;
        }

        container.innerHTML = macros
          .map((macro) => {
            const actionsCount = JSON.parse(macro.actions || "[]").length;
            const deleteButton = isDevMode
              ? `<button onclick="deleteMacro('${macro.id}')" style="background:#e74c3c;">Excluir</button>`
              : "";
            return `
              <div class="macro-item ${!macro.enabled ? "disabled" : ""}">
                <div>
                  <strong>${macro.name}</strong>
                  <span class="badge">${macro.device_type}</span>
                  <span class="badge">${actionsCount} ações</span>
                </div>
                <div class="actions">
                  <button onclick="selectMacro('${macro.id}')" ${macro.enabled ? "" : "disabled"}>
                    Usar
                  </button>
                  <button onclick="editMacro('${macro.id}')" style="background:#3498db;">Editar</button>
                  ${deleteButton}
                </div>
              </div>
            `;
          })
          .join("");
      }

      function populateMacroSelect() {
        const select = document.getElementById("macro-select");
        if (!select) return;

        if (!macros.length) {
          select.innerHTML = '<option value="">Nenhum macro disponível</option>';
          return;
        }

        select.innerHTML =
          '<option value="">Selecione um macro</option>' +
          macros
            .map(
              (macro) =>
                `<option value="${macro.id}" ${preferences.macroId === macro.id ? "selected" : ""}>
                  ${macro.name} (${macro.device_type})
                </option>`
            )
            .join("");

        if (preferences.macroId) {
          handleMacroChange();
        }
      }

      function handleMacroChange() {
        const select = document.getElementById("macro-select");
        const details = document.getElementById("macro-details");
        const selectedId = select.value;

        if (!selectedId) {
          preferences.macroId = "";
          details.textContent = "Escolha um macro para ver detalhes.";
          if (document.getElementById("auto-save").checked) {
            savePreferences(true);
          }
          return;
        }

        const macro = macros.find((m) => m.id === selectedId);
        if (!macro) return;

        preferences.macroId = macro.id;
        document.getElementById("device-select").value = macro.device_type;
        preferences.device = macro.device_type;

        const actionsCount = JSON.parse(macro.actions || "[]").length;
        details.innerHTML = `
          <strong>${macro.name}</strong><br />
          Dispositivo original: ${macro.device_type}<br />
          Ações gravadas: ${actionsCount}
        `;

        if (document.getElementById("auto-save").checked) {
          savePreferences(true);
        }
      }

      function selectMacro(id) {
        const select = document.getElementById("macro-select");
        if (select) {
          select.value = id;
          handleMacroChange();
        }
      }

      function editMacro(id) {
        window.location.href = `editor-macro.html?id=${encodeURIComponent(id)}`;
      }

      async function deleteMacro(id) {
        if (!currentUser || currentUser.role !== "dev") {
          showNotification("Somente DEV pode excluir macros", "warning");
          return;
        }

        const macro = macros.find((m) => m.id === id);
        const label = macro?.name || "este macro";

        if (!window.confirm(`Tem certeza que deseja excluir "${label}"? Esta ação nao pode ser desfeita.`)) {
          return;
        }

        try {
          const { error } = await supabaseClient.from("macros").delete().eq("id", id);
          if (error) throw error;

          macros = macros.filter((m) => m.id !== id);
          if (preferences.macroId === id) {
            preferences.macroId = "";
            if (document.getElementById("macro-select")) {
              document.getElementById("macro-select").value = "";
            }
            localStorage.setItem(PREFS_KEY, JSON.stringify(preferences));
            const details = document.getElementById("macro-details");
            if (details) {
              details.textContent = "Escolha um macro para ver detalhes.";
            }
          }

          renderMacroList();
          populateMacroSelect();
          showNotification("Macro excluído com sucesso.", "success");
        } catch (error) {
          console.error("Erro ao excluir macro:", error);
          showNotification("Erro ao excluir macro: " + error.message, "error");
        }
      }

      init();
    </script>
  </body>
</html>
