<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Macros</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="menu-container"></div>

    <div class="container">
      <h1>Gerenciar Macros</h1>

      <div class="actions" id="actions-buttons">
        <button id="record-btn" onclick="showRecordingPanel()">Gravar Novo Macro</button>
      </div>

      <div id="recording-panel" style="display: none">
        <h3>Configurar Gravação</h3>
        <div class="form-group">
          <label>Dispositivo:</label>
          <select id="device-type">
            <option value="desktop">Desktop</option>
            <option value="mobile">Mobile</option>
          </select>
        </div>
        <div class="form-group">
          <label>URL inicial (opcional):</label>
          <input
            type="text"
            id="start-url"
            placeholder="https://site.com ou deixe em branco para Google"
          />
          <small style="color:#666;">Use quando precisar abrir direto em uma p&aacute;gina espec&iacute;fica.</small>
        </div>
        <div class="form-group">
          <label style="display:flex; gap:8px; align-items:center; font-size:13px;">
            <input type="checkbox" id="record-fresh-session" />
            Iniciar com navegador limpo (sem cookies/logins salvos)
          </label>
        </div>
        <div class="form-group">
          <label>Nome do Macro:</label>
          <input type="text" id="macro-name" placeholder="Ex: Login Facebook" />
        </div>
        <div style="display: flex; gap: 10px">
          <button onclick="startRecording()" style="background: #28a745">
            Iniciar Gravação
          </button>
          <button onclick="hideRecordingPanel()" style="background: #6c757d">
            Cancelar
          </button>
        </div>
      </div>

      <div class="macros-list">
        <h3>Macros Salvos</h3>
        <div id="macros-container"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="notifications.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>

    <script>
      let recording = false;
      let currentMacroName = "";
      let currentDeviceType = "";
      let currentUser = null;

      async function init() {
        currentUser = await requirePagePermission("macros");
        if (!currentUser) return;
        document.getElementById("menu-container").innerHTML = createMenu();
        await loadMacros();
      }

      async function loadMacros() {
        const container = document.getElementById("macros-container");
        container.innerHTML = "<p>Carregando...</p>";

        try {
          const { data, error } = await supabaseClient
            .from("macros")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          if (!data || data.length === 0) {
            container.innerHTML = "<p>Nenhum macro cadastrado</p>";
            return;
          }

          container.innerHTML = data
            .map((macro) => {
              const actionsCount = JSON.parse(macro.actions || "[]").length;

              return `
                <div class="macro-item ${!macro.enabled ? "disabled" : ""}">
                  <div>
                    <strong>${macro.name}</strong>
                    <span class="badge">${macro.device_type}</span>
                    <span class="badge">${actionsCount} ações</span>
                  </div>
                  <div class="actions">
                    <button onclick="editMacro('${macro.id}')" style="background: #3498db;">Editar</button>
                    <button onclick="toggleMacro('${macro.id}', ${!macro.enabled})">
                      ${macro.enabled ? "Desabilitar" : "Habilitar"}
                    </button>
                    <button onclick="deleteMacro('${macro.id}')">Excluir</button>
                  </div>
                </div>
              `;
            })
            .join("");
        } catch (error) {
          container.innerHTML = "<p>Erro ao carregar macros</p>";
          showNotification("Erro ao carregar macros: " + error.message, "error");
        }
      }

      function showRecordingPanel() {
        document.getElementById("recording-panel").style.display = "block";
        document.getElementById("macro-name").focus();
      }

      function hideRecordingPanel() {
        document.getElementById("recording-panel").style.display = "none";
        document.getElementById("macro-name").value = "";
        document.getElementById("start-url").value = "";
      }

      function updateActionsButton(mode) {
        const container = document.getElementById("actions-buttons");

        if (mode === "recording") {
          container.innerHTML =
            '<button id="stop-btn" style="background: #dc3545;">Parar e Salvar Gravação</button>';
          document.getElementById("stop-btn").addEventListener("click", stopRecording);
        } else {
          container.innerHTML =
            '<button id="record-btn">Gravar Novo Macro</button>';
          document.getElementById("record-btn").addEventListener("click", showRecordingPanel);
        }
      }

      async function startRecording() {
        const name = document.getElementById("macro-name").value.trim();
        const deviceType = document.getElementById("device-type").value;
        const startUrl = document.getElementById("start-url").value.trim();

        if (!name) {
          showNotification("Digite um nome para o macro", "warning");
          document.getElementById("macro-name").focus();
          return;
        }

        currentMacroName = name;
        currentDeviceType = deviceType;
        recording = true;

        document.getElementById("recording-panel").style.display = "none";

        try {
          if (!window.electronAPI?.startRecording) {
            throw new Error("electronAPI.startRecording não está disponível");
          }

          await window.electronAPI.startRecording({
            device: deviceType,
            freshSession: document.getElementById("record-fresh-session").checked,
            startUrl: startUrl || null
          });
          showNotification("Gravação iniciada! Faça as ações no navegador...", "success");
          updateActionsButton("recording");
        } catch (error) {
          recording = false;
          currentMacroName = "";
          currentDeviceType = "";
          updateActionsButton("default");
          showNotification("Erro ao iniciar gravação: " + error.message, "error");
        }
      }

      async function stopRecording() {
        if (!recording) return;

        recording = false;

        try {
          if (!window.electronAPI?.stopRecording) {
            throw new Error("electronAPI.stopRecording não está disponível");
          }

          const actions = await window.electronAPI.stopRecording();

          if (!actions || actions.length === 0) {
            showNotification("Nenhuma ação foi gravada", "warning");
            updateActionsButton("default");
            currentMacroName = "";
            currentDeviceType = "";
            return;
          }

          const { data, error } = await supabaseClient
            .from("macros")
            .insert({
              name: currentMacroName,
              device_type: currentDeviceType,
              actions: JSON.stringify(actions),
              enabled: true,
            })
            .select();

          if (error) throw error;

          showNotification(
            `Macro "${currentMacroName}" salvo com ${actions.length} ações!`,
            "success"
          );

          currentMacroName = "";
          currentDeviceType = "";
          updateActionsButton("default");
          await loadMacros();
        } catch (error) {
          currentMacroName = "";
          currentDeviceType = "";
          updateActionsButton("default");
          showNotification("Erro ao salvar macro: " + error.message, "error");
        }
      }

      function editMacro(id) {
        window.location.href = `editor-macro.html?id=${encodeURIComponent(id)}`;
      }

      async function toggleMacro(id, enabled) {
        try {
          const { error } = await supabaseClient
            .from("macros")
            .update({ enabled })
            .eq("id", id);

          if (error) throw error;

          showNotification(enabled ? "Macro habilitado" : "Macro desabilitado", "success");
          await loadMacros();
        } catch (error) {
          showNotification("Erro: " + error.message, "error");
        }
      }

      async function deleteMacro(id) {
        const confirmDelete = await window.confirm(
          "Tem certeza que deseja excluir este macro?"
        );
        if (!confirmDelete) return;

        try {
          const { error } = await supabaseClient.from("macros").delete().eq("id", id);
          if (error) throw error;

          showNotification("Macro excluído", "success");
          await loadMacros();
        } catch (error) {
          showNotification("Erro: " + error.message, "error");
        }
      }

      init();
    </script>
  </body>
</html>
