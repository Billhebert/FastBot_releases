<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administra√ß√£o - FastBot</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin-container {
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .admin-header {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      border: 2px solid #c0392b;
    }

    .admin-header h1 {
      color: #fff;
      margin: 0 0 10px 0;
    }

    .admin-header p {
      color: rgba(255, 255, 255, 0.9);
      margin: 0;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #444;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 25px;
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .tab:hover {
      color: #d4af37;
    }

    .tab.active {
      color: #d4af37;
      border-bottom-color: #d4af37;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-box {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .stat-box h3 {
      color: #888;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .stat-box .value {
      color: #d4af37;
      font-size: 32px;
      font-weight: 700;
    }

    .users-table-container,
    .logs-container,
    .licenses-container {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid #444;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      color: #d4af37;
      margin: 0;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #d4af37 0%, #c49a2a 100%);
      color: #1a1a1a;
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: #fff;
    }

    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: #fff;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #1a1a1a;
    }

    thead th {
      color: #d4af37;
      font-size: 12px;
      font-weight: 600;
      text-align: left;
      padding: 12px 15px;
      text-transform: uppercase;
    }

    tbody tr {
      border-bottom: 1px solid #333;
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: rgba(212, 175, 55, 0.05);
    }

    tbody td {
      padding: 12px 15px;
      color: #ccc;
      font-size: 13px;
    }

    .role-badge {
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-dev {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .role-creator {
      background: rgba(241, 196, 15, 0.2);
      color: #f1c40f;
    }

    .role-consumer {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
    }

    .status-active {
      color: #2ecc71;
    }

    .status-expired {
      color: #e74c3c;
    }

    .btn-table {
      padding: 5px 12px;
      font-size: 11px;
      margin-right: 5px;
    }

    .log-entry {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .log-timestamp {
      color: #888;
      font-size: 12px;
    }

    .log-user {
      color: #d4af37;
      font-weight: 600;
    }

    .log-action {
      color: #ccc;
      font-size: 14px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      color: #d4af37;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 6px;
      color: #fff;
      padding: 10px 15px;
      font-size: 14px;
      outline: none;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #d4af37;
    }

    .warning-box {
      background: rgba(241, 196, 15, 0.1);
      border: 1px solid rgba(241, 196, 15, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .warning-box p {
      color: #f1c40f;
      margin: 0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="titlebar" id="titlebar"></header>

      <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
          <h1>‚ö†Ô∏è Painel de Administra√ß√£o</h1>
          <p>√Årea restrita para desenvolvedores - Controle total do sistema</p>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-overview">
          <div class="stat-box">
            <h3>Total de Usu√°rios</h3>
            <div class="value" id="stat-total-users">0</div>
          </div>
          <div class="stat-box">
            <h3>Usu√°rios Ativos</h3>
            <div class="value" id="stat-active-users">0</div>
          </div>
          <div class="stat-box">
            <h3>Licen√ßas V√°lidas</h3>
            <div class="value" id="stat-valid-licenses">0</div>
          </div>
          <div class="stat-box">
            <h3>Licen√ßas Expiradas</h3>
            <div class="value" id="stat-expired-licenses">0</div>
          </div>
          <div class="stat-box">
            <h3>Total de Execu√ß√µes</h3>
            <div class="value" id="stat-total-executions">0</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" onclick="switchTab('users')">üë• Usu√°rios</button>
          <button class="tab" onclick="switchTab('licenses')">üé´ Licen√ßas</button>
          <button class="tab" onclick="switchTab('logs')">üìã Logs de Auditoria</button>
          <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Configura√ß√µes</button>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content active">
          <div class="users-table-container">
            <div class="section-header">
              <h2>Gerenciamento de Usu√°rios</h2>
              <button class="btn btn-primary" onclick="openAddUserModal()">
                ‚ûï Adicionar Usu√°rio
              </button>
            </div>

            <div id="users-table-content">
              <p style="text-align: center; color: #888;">Carregando usu√°rios...</p>
            </div>
          </div>
        </div>

        <!-- Licenses Tab -->
        <div id="tab-licenses" class="tab-content">
          <div class="licenses-container">
            <div class="section-header">
              <h2>Gerenciamento de Licen√ßas</h2>
              <button class="btn btn-primary" onclick="openExtendLicenseModal()">
                üîÑ Estender Licen√ßa
              </button>
            </div>

            <div class="warning-box">
              <p>‚ö†Ô∏è Aten√ß√£o: Modificar licen√ßas afeta diretamente o acesso dos usu√°rios ao sistema.</p>
            </div>

            <div id="licenses-table-content">
              <p style="text-align: center; color: #888;">Carregando licen√ßas...</p>
            </div>
          </div>
        </div>

        <!-- Logs Tab -->
        <div id="tab-logs" class="tab-content">
          <div class="logs-container">
            <div class="section-header">
              <h2>Logs de Auditoria</h2>
              <button class="btn btn-primary" onclick="loadAuditLogs()">
                üîÑ Atualizar
              </button>
            </div>

            <div id="logs-content">
              <p style="text-align: center; color: #888;">Carregando logs...</p>
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
          <div class="users-table-container">
            <div class="section-header">
              <h2>Configura√ß√µes do Sistema</h2>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label>Dura√ß√£o Padr√£o de Licen√ßa (dias)</label>
                <input type="number" id="default-license-days" value="30" min="1">
              </div>

              <div class="form-group">
                <label>M√°ximo de Execu√ß√µes Simult√¢neas</label>
                <input type="number" id="max-executions" value="12" min="1" max="50">
              </div>

              <div class="form-group">
                <label>Modo de Manuten√ß√£o</label>
                <select id="maintenance-mode">
                  <option value="off">Desativado</option>
                  <option value="on">Ativado</option>
                </select>
              </div>
            </div>

            <button class="btn btn-success" onclick="saveSystemSettings()">
              üíæ Salvar Configura√ß√µes
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="notifications.js"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>
  <script src="router.js"></script>

  <script>
    let currentUser = null;
    let allUsers = [];

    // Inicializar
    async function init() {
      currentUser = await requirePagePermission("admin");
      if (!currentUser) return;

      // Verificar se √© DEV
      if (currentUser.role !== 'dev') {
        showNotification('‚õî Acesso negado - √Årea exclusiva para desenvolvedores', 'error');
        setTimeout(() => navigate('macros'), 2000);
        return;
      }

      await loadAllData();
    }

    // Carregar todos os dados
    async function loadAllData() {
      try {
        await Promise.all([
          loadUsers(),
          loadStatistics(),
          loadAuditLogs()
        ]);
      } catch (error) {
        console.error('Erro ao carregar dados admin:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    // Carregar usu√°rios
    async function loadUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allUsers = data || [];
        renderUsersTable();
      } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        document.getElementById('users-table-content').innerHTML =
          '<p style="color: #e74c3c;">Erro ao carregar usu√°rios</p>';
      }
    }

    // Renderizar tabela de usu√°rios
    function renderUsersTable() {
      const container = document.getElementById('users-table-content');

      if (allUsers.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888;">Nenhum usu√°rio encontrado</p>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Criado Em</th>
              <th>Expira Em</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${allUsers.map(user => {
              const expiresAt = user.access_expires_at ? new Date(user.access_expires_at) : null;
              const isExpired = expiresAt && expiresAt < new Date();
              const isActive = !isExpired;

              return `
                <tr>
                  <td>${user.email}</td>
                  <td>
                    <span class="role-badge role-${user.role}">
                      ${user.role.toUpperCase()}
                    </span>
                  </td>
                  <td>${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
                  <td>${expiresAt ? expiresAt.toLocaleDateString('pt-BR') : 'Sem limite'}</td>
                  <td>
                    <span class="status-${isActive ? 'active' : 'expired'}">
                      ${isActive ? '‚úì Ativo' : '‚úó Expirado'}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-table btn-primary" onclick="editUser('${user.id}')">
                      ‚úèÔ∏è Editar
                    </button>
                    <button class="btn btn-table btn-success" onclick="extendLicense('${user.id}')">
                      üîÑ Estender
                    </button>
                    ${user.id !== currentUser.id ? `
                      <button class="btn btn-table btn-danger" onclick="deleteUser('${user.id}')">
                        üóëÔ∏è Excluir
                      </button>
                    ` : ''}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    // Carregar estat√≠sticas
    async function loadStatistics() {
      try {
        // Total de usu√°rios
        document.getElementById('stat-total-users').textContent = allUsers.length;

        // Usu√°rios ativos
        const activeUsers = allUsers.filter(u => {
          if (!u.access_expires_at) return true;
          return new Date(u.access_expires_at) > new Date();
        });
        document.getElementById('stat-active-users').textContent = activeUsers.length;

        // Licen√ßas v√°lidas e expiradas
        const validLicenses = activeUsers.length;
        const expiredLicenses = allUsers.length - validLicenses;
        document.getElementById('stat-valid-licenses').textContent = validLicenses;
        document.getElementById('stat-expired-licenses').textContent = expiredLicenses;

        // Total de execu√ß√µes (global)
        const { count } = await supabaseClient
          .from('macro_executions')
          .select('*', { count: 'exact', head: true });

        document.getElementById('stat-total-executions').textContent = count || 0;

      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
      }
    }

    // Carregar logs de auditoria
    async function loadAuditLogs() {
      try {
        // Por enquanto, vamos simular logs
        // No futuro, voc√™ pode criar uma tabela audit_logs
        const logsContent = document.getElementById('logs-content');

        logsContent.innerHTML = `
          <div class="log-entry">
            <div class="log-header">
              <span class="log-user">admin@fastbot.com</span>
              <span class="log-timestamp">${new Date().toLocaleString('pt-BR')}</span>
            </div>
            <div class="log-action">Acessou painel de administra√ß√£o</div>
          </div>
          <div class="log-entry">
            <div class="log-header">
              <span class="log-user">Sistema</span>
              <span class="log-timestamp">${new Date().toLocaleString('pt-BR')}</span>
            </div>
            <div class="log-action">Logs de auditoria inicializados</div>
          </div>
        `;

      } catch (error) {
        console.error('Erro ao carregar logs:', error);
      }
    }

    // Trocar tab
    function switchTab(tabName) {
      // Desativar todas as tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // Ativar tab selecionada
      event.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Estender licen√ßa de usu√°rio
    async function extendLicense(userId) {
      const days = prompt('Quantos dias deseja adicionar √† licen√ßa?', '30');
      if (!days || isNaN(days)) return;

      try {
        const user = allUsers.find(u => u.id === userId);
        const currentExpiry = user.access_expires_at ? new Date(user.access_expires_at) : new Date();

        // Se j√° expirou, come√ßa de hoje
        const baseDate = currentExpiry > new Date() ? currentExpiry : new Date();
        const newExpiry = new Date(baseDate);
        newExpiry.setDate(newExpiry.getDate() + parseInt(days));

        const { error } = await supabaseClient
          .from('users')
          .update({ access_expires_at: newExpiry.toISOString() })
          .eq('id', userId);

        if (error) throw error;

        showNotification(`‚úÖ Licen√ßa estendida por ${days} dias!`, 'success');
        await loadUsers();

      } catch (error) {
        console.error('Erro ao estender licen√ßa:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    // Editar usu√°rio
    function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      const newRole = prompt(`Alterar role do usu√°rio ${user.email}?\nAtual: ${user.role}\n\nOp√ß√µes: dev, creator, consumer`, user.role);

      if (!newRole || !['dev', 'creator', 'consumer'].includes(newRole)) {
        showNotification('‚ö†Ô∏è Role inv√°lido', 'warning');
        return;
      }

      updateUserRole(userId, newRole);
    }

    // Atualizar role do usu√°rio
    async function updateUserRole(userId, newRole) {
      try {
        const { error } = await supabaseClient
          .from('users')
          .update({ role: newRole })
          .eq('id', userId);

        if (error) throw error;

        showNotification(`‚úÖ Role atualizado para ${newRole}!`, 'success');
        await loadUsers();

      } catch (error) {
        console.error('Erro ao atualizar role:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    // Excluir usu√°rio
    async function deleteUser(userId) {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° excluir PERMANENTEMENTE o usu√°rio e TODOS os seus dados!\n\nDeseja continuar?')) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('users')
          .delete()
          .eq('id', userId);

        if (error) throw error;

        showNotification('‚úÖ Usu√°rio exclu√≠do', 'success');
        await loadUsers();
        await loadStatistics();

      } catch (error) {
        console.error('Erro ao excluir usu√°rio:', error);
        showNotification(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    // Salvar configura√ß√µes do sistema
    function saveSystemSettings() {
      const defaultDays = document.getElementById('default-license-days').value;
      const maxExecutions = document.getElementById('max-executions').value;
      const maintenanceMode = document.getElementById('maintenance-mode').value;

      // Salvar no localStorage por enquanto
      localStorage.setItem('fastbot_system_settings', JSON.stringify({
        defaultLicenseDays: parseInt(defaultDays),
        maxExecutions: parseInt(maxExecutions),
        maintenanceMode
      }));

      showNotification('‚úÖ Configura√ß√µes salvas!', 'success');
    }

    // Abrir modal de adicionar usu√°rio (placeholder)
    function openAddUserModal() {
      showNotification('‚ö†Ô∏è Funcionalidade em desenvolvimento', 'warning');
    }

    // Abrir modal de estender licen√ßa (placeholder)
    function openExtendLicenseModal() {
      showNotification('üí° Use o bot√£o "Estender" na linha do usu√°rio', 'info');
    }

    init();
  </script>
</body>
</html>
