<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Executar Navegadores</title>
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .link-config {
        background: rgba(30, 30, 30, 0.8);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .link-config input[type="text"] {
        flex: 1;
        padding: 8px 12px;
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
      }

      .link-config input[type="text"]:focus {
        outline: none;
        border-color: #d4af37;
      }

      .spinner-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .spinner-btn {
        background: #333;
        border: 1px solid #444;
        color: #fff;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .spinner-btn:hover {
        background: #444;
        transform: scale(1.1);
      }

      .spinner-value {
        width: 50px;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: #fff;
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 6px;
      }

      .btn-remove-link {
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .btn-remove-link:hover {
        background: rgba(231, 76, 60, 0.4);
      }

      .grid-10 {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 10px;
        background: rgba(30, 30, 30, 0.8);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 20px;
      }

      .grid-slot {
        aspect-ratio: 16/9;
        background: #1a1a1a;
        border: 2px dashed #444;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 24px;
        font-weight: 700;
        transition: all 0.3s;
        position: relative;
        min-height: 120px;
      }

      .grid-slot.occupied {
        border-style: solid;
        border-color: #2ecc71;
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .grid-slot:hover {
        border-color: #d4af37;
        color: #d4af37;
      }

      .grid-slot .slot-info {
        font-size: 12px;
        color: #888;
        margin-top: 5px;
        text-align: center;
        max-width: 90%;
        word-wrap: break-word;
      }

      .actions-menu {
        background: rgba(30, 30, 30, 0.8);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 20px;
        display: none;
      }

      .actions-menu.visible {
        display: block;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .action-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .action-btn {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
      }

      .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        border-color: #d4af37;
      }

      .action-btn.active {
        background: linear-gradient(135deg, #d4af37 0%, #c49a2a 100%);
        color: #1a1a1a;
        border-color: #d4af37;
      }

      .action-btn h3 {
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .action-btn.active h3 {
        color: #1a1a1a;
      }

      .action-btn p {
        color: #888;
        font-size: 13px;
      }

      .game-input-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .game-input-group input {
        flex: 1;
        padding: 8px 12px;
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
      }

      .game-input-group select {
        padding: 8px 12px;
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
      }

      .game-input-group input:focus,
      .game-input-group select:focus {
        outline: none;
        border-color: #d4af37;
      }

      .execution-progress {
        background: rgba(30, 30, 30, 0.8);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
      }

      .progress-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .progress-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .progress-status.pending {
        background: #888;
      }

      .progress-status.success {
        background: #2ecc71;
      }

      .progress-status.error {
        background: #e74c3c;
      }

      .progress-info {
        flex: 1;
        font-size: 14px;
      }

      .total-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid #d4af37;
        border-radius: 8px;
        margin-top: 15px;
      }

      .total-summary strong {
        color: #d4af37;
        font-size: 18px;
      }

      .total-summary span {
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="menu-container"></div>

    <div class="workspace">
      <header class="workspace-header">
        <div>
          <p class="title">Executar Navegadores</p>
          <p class="meta">Grid de 10 navegadores com automação via LLM</p>
        </div>
        <div class="header-actions">
          <button class="btn-ghost" type="button" onclick="navigate('passwords')">
            Abrir Contas
          </button>
        </div>
      </header>

      <div class="panels-grid">
        <section class="panel">
          <div class="panel-header">
            <strong>Configuração de Links</strong>
            <span class="meta">Configure URLs e quantidades</span>
          </div>

          <div id="links-config-container">
            <!-- Links serão adicionados dinamicamente -->
          </div>

          <div class="total-summary">
            <span>Total de navegadores: </span>
            <strong id="total-browsers">0 / 10</strong>
          </div>

          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn-primary" type="button" onclick="addLink()">
              + Adicionar Link
            </button>
            <button class="btn-primary" type="button" id="btn-open-browsers" onclick="openBrowsers()">
              Abrir Navegadores
            </button>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <strong>Grid de Navegadores</strong>
            <span class="meta">Visualização 2x5</span>
          </div>

          <div class="grid-10" id="grid-container">
            <!-- Slots do grid serão gerados dinamicamente -->
          </div>
        </section>
      </div>

      <div class="panels-grid" id="actions-panel" style="display: none;">
        <section class="panel">
          <div class="panel-header">
            <strong>Ações nos Navegadores</strong>
            <span class="meta">Executar após todos navegadores carregarem</span>
          </div>

          <div class="actions-menu visible">
            <div class="action-grid">
              <div class="action-btn" id="action-create-account" onclick="executeAction('createAccount')">
                <h3>Criar Conta</h3>
                <p>Analisa formulário e preenche automaticamente</p>
              </div>

              <div class="action-btn" id="action-create-deposit" onclick="executeAction('createDeposit')">
                <h3>Criar Depósito</h3>
                <p>Encontra campo de depósito e valor</p>
              </div>

              <div class="action-btn" id="action-go-to-game" onclick="executeAction('goToGame')">
                <h3>Ir até Jogo</h3>
                <p>Navega para jogo específico</p>
                <div class="game-input-group">
                  <input type="text" id="game-name-input" placeholder="Nome do jogo...">
                  <select id="predefined-games-select">
                    <option value="">Selecionar jogo...</option>
                  </select>
                </div>
              </div>

              <div class="action-btn" id="action-close-popup" onclick="executeAction('closePopup')">
                <h3>Fechar Popup</h3>
                <p>Identifica e fecha popups automaticamente</p>
              </div>
            </div>
          </div>

          <div class="execution-progress" id="execution-progress" style="display: none;">
            <div class="panel-header">
              <strong>Progresso da Execução</strong>
              <span class="meta" id="progress-summary">0/0 concluídos</span>
            </div>
            <div id="progress-container"></div>
          </div>
        </section>
      </div>

      <div class="panels-grid">
        <section class="panel">
          <div class="panel-header">
            <strong>Status da Execução</strong>
            <span class="meta">Logs em tempo real</span>
          </div>
          <div id="status-summary" class="status-summary">Aguardando configuração...</div>
          <div class="execution-log" id="execution-log"></div>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="notifications.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth.js"></script>
    <script src="router.js"></script>

    <script>
      let currentUser = null;
      let links = [];
      let predefinedGames = [];
      let browsers = [];
      let browsersOpened = false;

      async function init() {
        currentUser = await requirePagePermission("execute");
        if (!currentUser) return;
        document.getElementById("menu-container").innerHTML = createMenu(currentUser);
        await loadPredefinedGames();
        updateGrid();
      }

      function addLink() {
        const linkId = Date.now();
        links.push({
          id: linkId,
          url: '',
          count: 1
        });
        renderLinks();
        updateGrid();
      }

      function removeLink(id) {
        links = links.filter(link => link.id !== id);
        renderLinks();
        updateGrid();
      }

      function updateLinkUrl(id, url) {
        const link = links.find(l => l.id === id);
        if (link) {
          link.url = url;
        }
      }

      function updateLinkCount(id, delta) {
        const link = links.find(l => l.id === id);
        if (link) {
          let newCount = link.count + delta;
          newCount = Math.max(0, Math.min(10, newCount));
          
          const total = getTotalBrowserCount() - link.count + newCount;
          if (total > 10) {
            showNotification('Máximo de 10 navegadores', 'warning');
            return;
          }
          
          link.count = newCount;
        }
        renderLinks();
        updateGrid();
      }

      function getTotalBrowserCount() {
        return links.reduce((sum, link) => sum + link.count, 0);
      }

      function renderLinks() {
        const container = document.getElementById('links-config-container');
        
        if (links.length === 0) {
          container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">Nenhum link configurado</p>';
          return;
        }

        container.innerHTML = links.map((link, index) => `
          <div class="link-config">
            <input type="text" placeholder="https://..." value="${link.url}" onchange="updateLinkUrl(${link.id}, this.value)" />
            <div class="spinner-container">
              <button class="spinner-btn" onclick="updateLinkCount(${link.id}, -1)">-</button>
              <input type="number" class="spinner-value" value="${link.count}" readonly />
              <button class="spinner-btn" onclick="updateLinkCount(${link.id}, 1)">+</button>
            </div>
            <button class="btn-remove-link" onclick="removeLink(${link.id})">Remover</button>
          </div>
        `).join('');

        document.getElementById('total-browsers').textContent = `${getTotalBrowserCount()} / 10`;
      }

      function updateGrid() {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        let slotIndex = 0;

        for (const link of links) {
          for (let i = 0; i < link.count; i++) {
            if (slotIndex >= 10) break;
            
            const slotNumber = slotIndex + 1;
            const slotUrl = link.url || 'Link não configurado';
            
            container.innerHTML += `
              <div class="grid-slot occupied">
                <span>${slotNumber}</span>
                <div class="slot-info">${slotUrl}</div>
              </div>
            `;
            
            slotIndex++;
          }
          
          if (slotIndex >= 10) break;
        }

        for (let i = slotIndex; i < 10; i++) {
          container.innerHTML += `
            <div class="grid-slot">
              <span>${i + 1}</span>
              <div class="slot-info">Vazio</div>
            </div>
          `;
        }
      }

      async function openBrowsers() {
        if (links.length === 0) {
          showNotification('Configure pelo menos um link', 'warning');
          return;
        }

        const total = getTotalBrowserCount();
        if (total === 0) {
          showNotification('Configure quantidade de navegadores', 'warning');
          return;
        }

        document.getElementById('btn-open-browsers').disabled = true;
        log('Iniciando abertura de navegadores...', 'info');

        try {
          if (!window.electronAPI) {
            throw new Error('ElectronAPI não disponível');
          }

          const config = {
            links: links.map(link => ({
              url: link.url,
              count: link.count
            }))
          };

          const result = await window.electronAPI.browserGrid.open(config);
          
          if (result.success) {
            browsers = result.browsers || [];
            browsersOpened = true;
            
            log(`${browsers.length} navegadores abertos com sucesso!`, 'success');
            
            document.getElementById('actions-panel').style.display = 'grid';
            showNotification('Navegadores abertos! Ações disponíveis.', 'success');
          } else {
            throw new Error(result.error || 'Erro ao abrir navegadores');
          }
        } catch (error) {
          log(`Erro: ${error.message}`, 'error');
          showNotification('Erro ao abrir navegadores', 'error');
        } finally {
          document.getElementById('btn-open-browsers').disabled = false;
        }
      }

      async function executeAction(action) {
        if (!browsersOpened) {
          showNotification('Abra os navegadores primeiro', 'warning');
          return;
        }

        let params = {};
        
        if (action === 'goToGame') {
          const customName = document.getElementById('game-name-input').value;
          const predefinedValue = document.getElementById('predefined-games-select').value;
          
          if (predefinedValue) {
            params.gameName = predefinedValue;
          } else if (customName) {
            params.gameName = customName;
          } else {
            showNotification('Informe o nome do jogo', 'warning');
            return;
          }
        }

        log(`Executando ação: ${action}...`, 'info');
        
        const progressContainer = document.getElementById('execution-progress');
        const progressItems = document.getElementById('progress-container');
        
        progressContainer.style.display = 'block';
        progressItems.innerHTML = '';

        document.getElementById('progress-summary').textContent = `0/${browsers.length} concluídos`;

        try {
          if (!window.electronAPI) {
            throw new Error('ElectronAPI não disponível');
          }

          const result = await window.electronAPI.browserGrid.executeAction({
            action,
            params,
            browsers: browsers
          });

          if (result.success) {
            const results = result.results || {};
            
            Object.entries(results).forEach(([browserIndex, result]) => {
              const status = result.status === 'success' ? 'success' : 'error';
              const message = result.error || 'Concluído';
              
              progressItems.innerHTML += `
                <div class="progress-item">
                  <div class="progress-status ${status}"></div>
                  <div class="progress-info">
                    <strong>Navegador ${parseInt(browserIndex) + 1}:</strong> ${message}
                  </div>
                </div>
              `;
            });

            const successCount = Object.values(results).filter(r => r.status === 'success').length;
            document.getElementById('progress-summary').textContent = `${successCount}/${browsers.length} concluídos`;

            log(`Ação ${action} concluída!`, 'success');
          } else {
            throw new Error(result.error || 'Erro ao executar ação');
          }
        } catch (error) {
          log(`Erro: ${error.message}`, 'error');
          showNotification('Erro ao executar ação', 'error');
        }
      }

      async function loadPredefinedGames() {
        try {
          const { data } = await supabaseClient
            .from('predefined_games')
            .select('*')
            .order('name');

          predefinedGames = data || [];

          const select = document.getElementById('predefined-games-select');
          select.innerHTML = '<option value="">Selecionar jogo...</option>';

          predefinedGames.forEach(game => {
            select.innerHTML += `<option value="${game.name}">${game.name}</option>`;
          });
        } catch (error) {
          console.error('Erro ao carregar jogos:', error);
        }
      }

      function log(msg, type = 'info') {
        const colors = {
          info: '#0f0',
          success: '#0f0',
          warning: '#ff0',
          error: '#f00'
        };
        
        const container = document.getElementById('execution-log');
        container.innerHTML += `<p style="color: ${colors[type]}; margin-bottom: 5px;">[${new Date().toLocaleTimeString()}] ${msg}</p>`;
        container.scrollTop = container.scrollHeight;
      }

      init();
    </script>
  </body>
</html>
